#!/bin/sh

process="$1"
user="$2"
group="$3"
signal="$4"
time="$5"
app="$6"

/usr/lib/systemd/systemd-coredump "$process" "$user" "$group" "$signal" "$time" "$app"

temppath=@CRASH_TEMP@
resultpath=@CRASH_PATH@
name="$app"_"$process"_"$time"
path="$temppath"/"$name"
info="$name".info
dump="$name".coredump
log="$name".log
result="$name".tar.gz

/usr/bin/mkdir -p "$temppath"
/usr/bin/mkdir -p "$resultpath"
/usr/bin/mkdir -p "$path"

cd "$path"

/usr/bin/coredumpctl info "$process" >> "$info"
/usr/bin/coredumpctl dump "$process" --output="$dump"
/usr/bin/dump_systemstate -d -k -f "$log"

cd "$temppath"
/usr/bin/tar cvfz "$result" "$name"/"$dump" "$name"/"$info" "$name"/"$log"

/usr/bin/mv "$temppath"/"$result" "$resultpath"/"$result"

/usr/bin/rm -rf "$path"
