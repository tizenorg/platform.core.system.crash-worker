#!/bin/sh

set -e
exec >/dev/null 2>&1

PATH=/bin:/usr/bin
CRASH_PATH="@CRASH_PATH@"
CRASH_TEMP="@CRASH_TEMP@"

# Expected invocation from kernel:
#
#   argv0 PID UID GID SIGNAL TIME CMD
pid="$1"
time="$5"
cmd="$6"

temp_dir="$(mktemp -d "${CRASH_TEMP}/crash.XXXXXX")"
cleanup()
{
    [ "$temp_dir" ] && rm -rf "$temp_dir"
}
trap cleanup 0 2 15

name="${cmd}_${pid}_${time}"
result_path="${CRASH_PATH}/${name}.tar.gz"
pfx="${temp_dir}/${name}"
info_path="${pfx}/${name}.info"
core_path="${pfx}/${name}.coredump"
log_path="${pfx}/${name}.log"

mkdir -p "$CRASH_PATH" "$pfx"

@CRASH_PIPE_PATH@ --save-core "$core_path" --report "$@" > "$info_path"
@CRASH_STACK_PATH@ "$core_path" >> "$info_path"
dump_systemstate -d -k -f "$log_path" || true

tar czf "${temp_dir}/report.tar.gz" -C "$temp_dir" "$name"
mv "${temp_dir}/report.tar.gz" "$result_path"
