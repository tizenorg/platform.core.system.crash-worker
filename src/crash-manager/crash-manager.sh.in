#!/bin/sh

process="$1"
user="$2"
group="$3"
signal="$4"
time="$5"
app="$6"

/usr/lib/systemd/systemd-coredump "$process" "$user" "$group" "$signal" "$time" "$app"

rootpath=@CRASH_PATH@
name="$app"_"$process"_"$time"
path="$rootpath"/"$name"
info="$name".info
dump="$name".coredump
log="$name".log
result="$name".tar.gz

/usr/bin/mkdir -p "$rootpath"
/usr/bin/mkdir -p "$path"

cd "$path"

/usr/bin/coredumpctl info "$process" >> "$info"
/usr/bin/coredumpctl dump "$process" --output="$dump"
/usr/bin/dump_systemstate -d -k -f "$log"

/usr/bin/tar cvfz ../"$result" "$dump" "$info" "$log"

cd ..

/usr/bin/rm -rf "$path"
