#!/bin/sh

process="$1"
user="$2"
group="$3"
signal="$4"
time="$5"
app="$6"

@PREFIX@/lib/systemd/systemd-coredump "$process" "$user" "$group" "$signal" "$time" "$app"

temppath=@CRASH_TEMP@
resultpath=@CRASH_PATH@
name="$app"_"$process"_"$time"
path="$temppath"/"$name"
info="$name".info
dump="$name".coredump
log="$name".log
result="$name".tar.gz

@TZ_SYS_BIN@/mkdir -p "$temppath"
@TZ_SYS_BIN@/mkdir -p "$resultpath"
@TZ_SYS_BIN@/mkdir -p "$path"

cd "$path"

@TZ_SYS_BIN@/coredumpctl info "$process" >> "$info"
@TZ_SYS_BIN@/coredumpctl dump "$process" --output="$dump"
@TZ_SYS_BIN@/dump_systemstate -d -k -f "$log"

cd "$temppath"
@TZ_SYS_BIN@/tar cvfz "$result" "$name"/"$dump" "$name"/"$info" "$name"/"$log"

@TZ_SYS_BIN@/mv "$temppath"/"$result" "$resultpath"/"$result"

@TZ_SYS_BIN@/rm -rf "$path"
